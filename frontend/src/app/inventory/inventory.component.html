<!-- inventory.component.html - VERSI√ìN COMPLETA CON DUPLICADOS -->
<div class="container">
  <h2>üì¶ Inventario de Productos</h2>

  <!-- üî• GR√ÅFICO DE BAJO STOCK -->
  <app-low-stock-chart></app-low-stock-chart>

  <app-high-stock-chart></app-high-stock-chart>
  
  <!-- Formulario de Agregar Producto -->
  <form (ngSubmit)="addItem()" class="form"> 
    <input [(ngModel)]="newItem.name" name="name" placeholder="Nombre del producto" required />
    <input [(ngModel)]="newItem.description" name="description" placeholder="Descripci√≥n" required />
    <input [(ngModel)]="newItem.price" name="price" type="number" placeholder="Precio" required />
    <input [(ngModel)]="newItem.quantity" name="quantity" type="number" placeholder="Cantidad" required />
    
    <button type="submit" class="btn-add">‚ûï Agregar</button>
    <button type="button" class="btn-excel" (click)="openExcelUploader()">
      üìä Carga Masiva Excel
    </button>
  </form>

  <!-- Barra de B√∫squeda -->
  <div class="search-bar">
    <input name="search" [(ngModel)]="searchTerm" placeholder="üîç Buscar producto..." />
    <button type="button" (click)="applyFilter()">Buscar</button>
  </div>
  <!-- Despu√©s del formulario -->
  <div *ngIf="duplicateWarning" class="alert alert-warning">
    <span class="alert-icon">‚ö†Ô∏è</span>
    <span>{{ duplicateWarning }}</span>
  </div>
  <!-- Lista de Productos -->
  <ul class="item-list">
    <li *ngFor="let item of paginatedItems">
      <div class="item-content">
        <div class="item-info">
          <strong>{{ item.name }}</strong>
          <span class="item-description">{{ item.description }}</span>
        </div>
        <div class="item-details">
          <span class="item-price">üí∞ ${{ item.price }}</span>
          <span class="item-quantity">üì¶ {{ item.quantity }}</span>
        </div>
      </div>
      <button class="btn-delete" (click)="deleteItem(item.id)">üóëÔ∏è</button>
    </li>
  </ul>

  <!-- Paginaci√≥n Mejorada -->
  <div class="pagination">
    <button 
      (click)="prevPage()" 
      [disabled]="currentPage === 1"
      class="pagination-btn">
      ‚¨ÖÔ∏è Anterior
    </button>
    
    <div class="page-numbers">
      <button 
        *ngFor="let page of getPageNumbers()" 
        (click)="page > 0 && goToPage(page)"
        [class.active]="page === currentPage"
        [class.dots]="page === -1"
        [disabled]="page === -1"
        class="page-number">
        {{ page === -1 ? '...' : page }}
      </button>
    </div>
    
    <button 
      (click)="nextPage()" 
      [disabled]="currentPage === totalPages()"
      class="pagination-btn">
      Siguiente ‚û°Ô∏è
    </button>
  </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE CARGA EXCEL -->
<!-- ============================================ -->
<div *ngIf="showExcelModal" class="modal-overlay" (click)="closeExcelModal()">
  <div class="modal-excel" (click)="$event.stopPropagation()">
    <div class="modal-excel-header">
      <h3>üìä Carga Masiva desde Excel</h3>
      <button class="btn-close-modal" (click)="closeExcelModal()">‚úï</button>
    </div>

    <div class="modal-excel-body">
      <!-- Alertas de Error -->
      <div *ngIf="generalError" class="alert alert-error">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <span>{{ generalError }}</span>
      </div>

      <!-- ZONA DE CARGA DE ARCHIVO -->
      <div *ngIf="!showPreview && !isUploading && !showSheetSelector" class="upload-zone">
        <input type="file" id="fileInputModal" accept=".xls,.xlsx" (change)="onFileSelected($event)"
          style="display: none" />
        <label for="fileInputModal" class="upload-area">
          <div class="upload-icon">üìÅ</div>
          <p class="upload-text">
            <strong>Haz clic para seleccionar</strong> o arrastra tu archivo Excel aqu√≠
          </p>
          <p class="upload-hint">Formatos: .xls, .xlsx (m√°x. 10 MB)</p>
        </label>
        <div *ngIf="fileName" class="file-info">
          <div class="file-icon">üìÑ</div>
          <div class="file-details">
            <p class="file-name">{{ fileName }}</p>
            <p class="file-size">{{ formatFileSize(fileSize) }}</p>
          </div>
        </div>
      </div>

      <!-- SELECTOR DE HOJAS -->
      <div *ngIf="showSheetSelector && !showPreview && !isUploading" class="sheet-selector">
        <h4>Selecciona una hoja para cargar</h4>
        <p class="sheet-hint">Se detectaron {{ sheets.length }} hojas en el archivo</p>
        <div class="sheets-grid">
          <div *ngFor="let sheet of sheets" 
               class="sheet-card" 
               [class.sheet-valid]="sheet.is_valid"
               [class.sheet-invalid]="!sheet.is_valid" 
               (click)="sheet.is_valid && selectSheet(sheet.name)">
            <div class="sheet-header">
              <span class="sheet-name">{{ sheet.name }}</span>
              <span class="sheet-status" 
                    [class.status-valid]="sheet.is_valid" 
                    [class.status-invalid]="!sheet.is_valid">
                {{ sheet.is_valid ? '‚úì' : '‚úó' }}
              </span>
            </div>
            <div class="sheet-info">
              <p>{{ sheet.rows }} filas</p>
              <p>{{ sheet.columns.length }} columnas</p>
            </div>
            <div *ngIf="!sheet.is_valid" class="sheet-errors">
              <p *ngFor="let error of sheet.errors" class="error-item">‚Ä¢ {{ error }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- VISTA PREVIA CON INDICADORES DE DUPLICADOS -->
      <div *ngIf="showPreview && !isUploading" class="preview-container">
        <!-- Header con Estad√≠sticas -->
        <div class="preview-header">
          <div class="preview-title-section">
            <h4>Vista Previa - {{ selectedSheet }}</h4>
            <p class="preview-info">Mostrando {{ previewData.length }} de {{ totalRows }} filas</p>
            
            <!-- Estad√≠sticas de Duplicados -->
            <div *ngIf="hasDuplicates || newProductsCount > 0" class="preview-stats">
              <span class="stat-badge stat-new" *ngIf="newProductsCount > 0">
                ‚ú® {{ newProductsCount }} Nuevos
              </span>
              <span class="stat-badge stat-duplicate" *ngIf="duplicatesCount > 0">
                ‚ö†Ô∏è {{ duplicatesCount }} Duplicados
              </span>
            </div>
          </div>

          <div class="preview-actions">
            <button class="btn-secondary-modal" (click)="cancelPreview()">‚¨ÖÔ∏è Volver</button>
            <button class="btn-primary-modal" (click)="confirmUpload()">‚úì Confirmar Carga</button>
          </div>
        </div>

        <!-- Leyenda de Colores -->
        <div class="preview-legend">
          <span class="legend-item">
            <span class="legend-color legend-new"></span>
            Producto nuevo
          </span>
          <span class="legend-item">
            <span class="legend-color legend-duplicate"></span>
            Producto duplicado
          </span>
          <span class="legend-item">
            <span class="legend-color legend-error"></span>
            Error de validaci√≥n
          </span>
        </div>

        <!-- Tabla de Preview -->
        <div class="table-container">
          <table class="preview-table">
            <thead>
              <tr>
                <th class="status-col">Estado</th>
                <th class="actions-col">Acciones</th>
                <th *ngFor="let col of columns">{{ col }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of previewData" 
                  [class.editing]="editingRow === row"
                  [ngClass]="getRowClass(row)">
                
                <!-- Columna de Estado -->
                <td class="status-cell">
                  <span class="status-badge" [ngClass]="'badge-' + row.status">
                    {{ row.status_label || '-' }}
                  </span>
                  <span *ngIf="row.status === 'duplicate'" class="duplicate-info" 
                        [title]="'ID existente: ' + row.existing_id">
                    üîó
                  </span>
                </td>

                <!-- Columna de Acciones -->
                <td class="actions-cell">
                  <button *ngIf="editingRow !== row" 
                          class="btn-icon btn-edit" 
                          (click)="startEdit(row)"
                          title="Editar">‚úèÔ∏è</button>
                  <button *ngIf="editingRow === row" 
                          class="btn-icon btn-save" 
                          (click)="saveEdit()"
                          title="Guardar">‚úì</button>
                  <button *ngIf="editingRow === row" 
                          class="btn-icon btn-cancel" 
                          (click)="cancelEdit()"
                          title="Cancelar">‚úó</button>
                  <button *ngIf="editingRow !== row" 
                          class="btn-icon btn-delete" 
                          (click)="deleteRow(row)"
                          title="Eliminar">üóëÔ∏è</button>
                </td>

                <!-- Columnas de Datos -->
                <td *ngFor="let col of columns">
                  <input *ngIf="editingRow === row" 
                         type="text" 
                         [(ngModel)]="row[col]" 
                         class="edit-input" />
                  <span *ngIf="editingRow !== row">{{ row[col] ?? '-' }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PROGRESO DE CARGA -->
      <div *ngIf="isUploading" class="upload-progress">
        <h4>Cargando Productos...</h4>

        <div class="progress-bar-container">
          <div class="progress-bar" 
               [style.width.%]="uploadProgress" 
               [style.background-color]="getProgressColor()">
          </div>
        </div>

        <p class="progress-percentage">{{ uploadProgress }}%</p>
        <p class="progress-message">{{ uploadMessage }}</p>

        <div class="upload-stats">
          <div class="stat-item stat-created">
            <span class="stat-label">Creados:</span>
            <span class="stat-value">{{ uploadStats.created }}</span>
          </div>
          <div class="stat-item stat-updated">
            <span class="stat-label">Actualizados:</span>
            <span class="stat-value">{{ uploadStats.updated }}</span>
          </div>
          <div class="stat-item stat-skipped">
            <span class="stat-label">Omitidos:</span>
            <span class="stat-value">{{ uploadStats.skipped }}</span>
          </div>
          <div class="stat-item stat-errors">
            <span class="stat-label">Errores:</span>
            <span class="stat-value">{{ uploadStats.errors }}</span>
          </div>
        </div>

        <div *ngIf="uploadProgress === 100" class="success-message">
          <div class="success-icon">‚úÖ</div>
          <p>¬°Carga completada exitosamente!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE OPCIONES PARA DUPLICADOS -->
<!-- ============================================ -->
<div *ngIf="showDuplicatesModal" class="modal-overlay" (click)="closeDuplicatesModal()">
  <div class="modal-duplicates" (click)="$event.stopPropagation()">
    <div class="modal-duplicates-header">
      <h3>‚ö†Ô∏è Productos Duplicados Detectados</h3>
    </div>

    <div class="modal-duplicates-body">
      <p class="duplicates-message">
        Se encontraron <strong>{{ duplicatesCount }}</strong> productos que ya existen en la base de datos.
      </p>
      <p class="duplicates-hint">
        Tambi√©n hay <strong>{{ newProductsCount }}</strong> productos nuevos que se agregar√°n.
      </p>

      <div class="duplicates-options">
        <h4>¬øC√≥mo deseas manejar los duplicados?</h4>
        
        <label class="option-card" 
               [class.selected]="selectedDuplicateAction === 'skip'">
          <input type="radio" 
                 name="duplicateAction" 
                 value="skip" 
                 [(ngModel)]="selectedDuplicateAction" />
          <div class="option-content">
            <span class="option-icon">‚äò</span>
            <div class="option-text">
              <strong>Omitir duplicados</strong>
              <p>Los productos duplicados NO se cargar√°n. Solo se agregar√°n los nuevos.</p>
            </div>
          </div>
        </label>

        <label class="option-card" 
               [class.selected]="selectedDuplicateAction === 'update'">
          <input type="radio" 
                 name="duplicateAction" 
                 value="update" 
                 [(ngModel)]="selectedDuplicateAction" />
          <div class="option-content">
            <span class="option-icon">‚Üª</span>
            <div class="option-text">
              <strong>Actualizar existentes</strong>
              <p>Los productos duplicados se actualizar√°n con los nuevos datos del Excel.</p>
            </div>
          </div>
        </label>

        <label class="option-card" 
               [class.selected]="selectedDuplicateAction === 'create_new'">
          <input type="radio" 
                 name="duplicateAction" 
                 value="create_new" 
                 [(ngModel)]="selectedDuplicateAction" />
          <div class="option-content">
            <span class="option-icon">‚ûï</span>
            <div class="option-text">
              <strong>Crear como nuevos</strong>
              <p>Los productos duplicados se crear√°n como registros nuevos (permite duplicados).</p>
            </div>
          </div>
        </label>
      </div>
    </div>

    <div class="modal-duplicates-footer">
      <button class="btn-secondary-modal" (click)="closeDuplicatesModal()">Cancelar</button>
      <button class="btn-primary-modal" (click)="proceedWithDuplicates()">Continuar</button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE ERRORES -->
<!-- ============================================ -->
<div *ngIf="showErrorDialog" class="error-modal-overlay" (click)="closeErrorDialog()">
  <div class="error-modal-content" (click)="$event.stopPropagation()">
    <div class="error-modal-header">
      <h3>‚ö†Ô∏è Errores Encontrados</h3>
      <button class="btn-close" (click)="closeErrorDialog()">‚úï</button>
    </div>
    <div class="error-modal-body">
      <p>Se encontraron {{ errors.length }} errores durante la carga:</p>
      <ul class="error-list">
        <li *ngFor="let error of errors">{{ error }}</li>
      </ul>
    </div>
    <div class="error-modal-footer">
      <button class="btn-primary-modal" (click)="closeErrorDialog()">Entendido</button>
    </div>
  </div>
</div>